# Sampling POC

This repo contains examples of possible architectures to do sampling and metrics generation.
Each example consists of two golang applications: `hello-world` and `foo`. `hello world` app sends http request to `foo` app.
There is k6 service is running to generate load on `hello-world` app.
Other services are:
- prometheus
- tempo
- grafana
- opentelemetry collector

## Tail and probabilistic based sampling on the Collector level, metrics generation is done in the Collector

```shell
cd otelcol-metrics-gen
docker compose up --build -d 
```

### Metrics generated by servicegraph collector component:
```
traces_service_graph_request_client_seconds_bucket
traces_service_graph_request_client_seconds_count
traces_service_graph_request_client_seconds_sum
traces_service_graph_request_server_seconds_bucket
traces_service_graph_request_server_seconds_count
traces_service_graph_request_server_seconds_sum
traces_service_graph_request_total`
```
### Metrics generated by spanmetrics collector component:
```
calls
duration_bucket
duration_count
duration_sum
```

## Head based sampling with SDK, metrics generation is done in Tempo 
```shell
cd tempo-metrics-gen
docker compose up --build -d
```

### Metrics generated by servicegraph tempo:
```
traces_service_graph_request_client_seconds_bucket
traces_service_graph_request_client_seconds_count
traces_service_graph_request_client_seconds_sum
traces_service_graph_request_server_seconds_bucket
traces_service_graph_request_server_seconds_count
traces_service_graph_request_server_seconds_sum
traces_service_graph_request_total
```

### Metrics generated by spanmetrics tempo:
```
traces_spanmetrics_calls_total
traces_spanmetrics_latency_bucket
traces_spanmetrics_latency_count
traces_spanmetrics_latency_sum
traces_spanmetrics_size_total
```

## Grafana dashboard to check it works:

Open Example dashboard in grafana localhost:3000

`Traces used for RED metrics generation` graph shows amount of traces per second used for metrics generation.
The amount of traces should be equal to RPS k6 server generates (50 traces/sec).
Which means we use all the traces to generate metrics, and metrics reflect the real load.

`Traces ingested in tempo` graph shows amount of traces tempo ingests per second.
The amount of traces should be equal `k6 RPS * sampling ration` (25 ops/sec).
Which means that only sampled traces are ingested by tempo
